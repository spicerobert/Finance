import requests 
from flask import Flask, request
import yfinance as yf
import pandas as pd
import matplotlib.pyplot as plt
import os

stock_id = '2330.TW'  # å°ç©é›»
token = 'è¦æ”¹æ”¹....7E4hgJ5TtYT+1BI26edJejutWHlfoskAzGqKeYMMKdt0xwRuGkT7P/WaYkEAlq++wdB04t89/1O/w1cDnyilFU='
# åˆå§‹åŒ– Flask æ‡‰ç”¨ç¨‹å¼
app = Flask(__name__)

def ç•«_KDåœ–(df, stock_id='2330'):
    plt.figure(figsize=(10, 5))
    plt.plot(df.index, df['K'], label='K', color='blue')
    plt.plot(df.index, df['D'], label='D', color='orange')
    plt.title(f'{stock_id} KD æŒ‡æ¨™åœ–')
    plt.xlabel('æ—¥æœŸ')
    plt.ylabel('å€¼')
    plt.legend()
    plt.grid(True)
    #filename = f'{stock_id}_KD.png'
    filename = f"static/{stock_id}_kd.png"
    plt.savefig(filename)
    plt.close()
    print(os.getcwd())
    return filename
    
def è¨ˆç®—_KD(df, n=9):
    df = df.copy()
    low_min = df['Low'].rolling(window=n).min()
    high_max = df['High'].rolling(window=n).max()
    df['RSV'] = (df['Close'] - low_min) / (high_max - low_min) * 100
    df['K'] = df['RSV'].ewm(com=2).mean()
    df['D'] = df['K'].ewm(com=2).mean()
    return df

def å‚³é€åˆ°_LINE(TOKEN, image_path, message='é€™æ˜¯ KD åœ–',reply_token=None,df_kd=None):

    image_url = request.host_url + image_path  # åƒ http://127.0.0.1:5000/static/2330_kd.png
    image_url = image_url.replace('//static', '/static')
    image_url = image_url.replace('http://', 'https://')
    åˆ†ææ–‡å­— = åˆ†æ_KD(df_kd)
    print(image_url)
    print(image_url)
    headers = {
        "Content-Type": "application/json",
        "Authorization": "Bearer " + TOKEN
    }
    payload = {
        "replyToken": reply_token,
        #"messages": [{
         "messages": [
        {
            "type": "text",
            "text": f"KD åˆ†æçµæœï¼š\n{åˆ†ææ–‡å­—}"
        },
        {
            "type": "image",
            "originalContentUrl": image_url,
            "previewImageUrl": image_url
        }
     ]
    }
    
    # ç™¼é€ POST è«‹æ±‚è‡³ LINE Messaging API
    r=response = requests.post(
        "https://api.line.me/v2/bot/message/reply",
        headers=headers,
        json=payload
    )
    return r.status_code
def åˆ†æ_KD(df):
    æœ€æ–°K = df['K'].iloc[-1]
    æœ€æ–°D = df['D'].iloc[-1]
    å‰ä¸€K = df['K'].iloc[-2]
    å‰ä¸€D = df['D'].iloc[-2]

    å»ºè­° = ""

    if å‰ä¸€K < å‰ä¸€D and æœ€æ–°K > æœ€æ–°D:
        å»ºè­° = "âœ… é»ƒé‡‘äº¤å‰ï¼Œè€ƒæ…®è²·é€²æ™‚æ©Ÿ"
    elif å‰ä¸€K > å‰ä¸€D and æœ€æ–°K < æœ€æ–°D:
        å»ºè­° = "âš ï¸ æ­»äº¡äº¤å‰ï¼Œå¯èƒ½è½‰è·Œï¼Œè¬¹æ…è§€å¯Ÿ"
    elif æœ€æ–°K < 20:
        å»ºè­° = "ğŸ”½ è¶…è³£å€ï¼Œå¯èƒ½åå½ˆ"
    elif æœ€æ–°K > 80:
        å»ºè­° = "ğŸ”¼ è¶…è²·å€ï¼Œå¯èƒ½ä¿®æ­£"
    else:
        å»ºè­° = "ğŸ“Š ç„¡æ˜ç¢ºäº¤å‰ï¼Œç¹¼çºŒè§€å¯Ÿ"
    return f"æœ€æ–° K å€¼ï¼š{æœ€æ–°K:.2f}\næœ€æ–° D å€¼ï¼š{æœ€æ–°D:.2f}\nå»ºè­°ï¼š{å»ºè­°}"

# LINE Webhook å…¥å£
@app.route("/", methods=['POST'])
def linebot():
    # å–å¾—ä½¿ç”¨è€…å‚³ä¾†çš„è³‡æ–™
    data = request.get_json()
#    print(data)
    if 'destination' not in data :
        print("æœ‰äººä¾†äº‚");
        abort(400)
    elif data['destination']=='è¦ä¿®æ”¹.3dfc9e37ce16047ab5c2d' and len(data["events"])>0:
        print("æœ‰äººé©—è­‰æˆåŠŸ")
    #    return "OK",200
    # æå– replyToken
    reply_token = data['events'][0]['replyToken']
    message = data["events"][0]["message"]['text']
    stock_id=message+".TW"
    # å›å‚³æ–‡å­—è¨Šæ¯
#    response = send_text_message(reply_token, "å›æ‡‰æ‚¨ä¸€å‰‡åœ–ç‰‡")
    
#    if response.status_code == 200:
#        return "OK", 200
#    else:
#        print("ç™¼é€è¨Šæ¯å¤±æ•—:", response.status_code, response.text)
#        return "Error", 400
    print("é–‹å§‹å¾yahooä¸‹è¼‰") 
    df = yf.download(stock_id, period='1mo', interval='1d')
    print("å®Œæˆå¾yahooä¸‹è¼‰, é–‹å§‹è¨ˆç®—KD")
    df_kd = è¨ˆç®—_KD(df)
    #print(df_kd)
    print("å®Œæˆè¨ˆç®—_KD, é–‹å§‹ç•«KDåœ–")
    image_file = ç•«_KDåœ–(df_kd, stock_id)
    print("å®Œæˆç•«KDåœ–, é–‹å‚³é€åˆ°line"+image_file)
    status = å‚³é€åˆ°_LINE(token, image_file, f'{stock_id} KD',reply_token,df_kd)
    print("å®Œæˆé€åˆ°line")
  # è™•ç†å¤±æ•—ç‹€æ³
    if df is None or df.empty:
        return 'æ‰¾ä¸åˆ°è©²è‚¡ç¥¨è³‡æ–™', 400
    # é€™è£¡ä½ å¯èƒ½é‚„æœƒç•«åœ–ã€é€ LINE ç­‰
    else:
    # æœ€å¾Œå‹™å¿… return
        return 'æˆåŠŸé€å‡º KD åœ–', 200
#print(f"ç™¼é€ç‹€æ…‹: {status}")
# å•Ÿå‹• Flask ä¼ºæœå™¨
if __name__ == "__main__":
    app.run(port= 3000)